<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[${workflow.runName}] nf-metalog report</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #fff;
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            margin-bottom: 30px;
        }
        
        h1, h2, h3 {
            color: #2c3e50;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 18px;
            margin-top: 0;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .summary-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
        }
        
        .summary-item h3 {
            margin-top: 0;
            font-size: 14px;
            color: #6c757d;
            font-weight: 600;
        }
        
        .summary-item p {
            margin-bottom: 0;
            font-size: 18px;
            font-weight: 500;
        }
        
        .nf-command {
            font-family: monospace;
            font-size: 14px;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .chart-container {
            margin: 20px 0;
            min-height: 400px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-failed {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-running {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-cached {
            background-color: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Nextflow Workflow Report</h1>
            <p class="subtitle">[${workflow.runName}]</p>
        </header>

        <!-- Workflow Summary Section -->
        <div class="section">
            <h2>Workflow Summary</h2>
            <div class="summary-grid">
                <div class="summary-item">
                    <h3>Status</h3>
                    <p><span class="status-badge status-${workflow.success ? 'completed' : 'failed'}">${workflow.success ? 'Completed' : 'Failed'}</span></p>
                </div>
                <div class="summary-item">
                    <h3>Start Time</h3>
                    <p>${workflow.start}</p>
                </div>
                <div class="summary-item">
                    <h3>Completion Time</h3>
                    <p>${workflow.complete}</p>
                </div>
                <div class="summary-item">
                    <h3>Duration</h3>
                    <p>${workflow.duration}</p>
                </div>
            </div>
        </div>

        <!-- Workflow Information Section -->
        <div class="section">
            <h2>Workflow Information</h2>
            
            <div class="summary-grid">
                <div class="summary-item">
                    <h3>Nextflow Command</h3>
                    <p><code class="nf-command">${workflow.commandLine}</code></p>
                </div>
                <div class="summary-item">
                    <h3>CPU-Hours</h3>
                    <p>${workflow.stats.computeTimeFmt}</p>
                </div>
                <div class="summary-item">
                    <h3>Launch Directory</h3>
                    <p><small>${workflow.launchDir}</small></p>
                </div>
                <div class="summary-item">
                    <h3>Work Directory</h3>
                    <p><small>${workflow.workDir.toUriString()}</small></p>
                </div>
                <div class="summary-item">
                    <h3>Project Directory</h3>
                    <p><small>${workflow.projectDir}</small></p>
                </div>
                <% if (workflow.scriptName) { %>
                <div class="summary-item">
                    <h3>Script Name</h3>
                    <p>${workflow.scriptName}</p>
                </div>
                <% } %>
                <% if (workflow.scriptId) { %>
                <div class="summary-item">
                    <h3>Script ID</h3>
                    <p><code>${workflow.scriptId}</code></p>
                </div>
                <% } %>
                <div class="summary-item">
                    <h3>Workflow Session</h3>
                    <p><code>${workflow.sessionId}</code></p>
                </div>
                <% if (workflow.repository) { %>
                <div class="summary-item">
                    <h3>Workflow Repository</h3>
                    <p><code>${workflow.repository}</code></p>
                </div>
                <% } %>
                <div class="summary-item">
                    <h3>Workflow Profile</h3>
                    <p>${workflow.profile}</p>
                </div>
                <% if (workflow.container) { %>
                <div class="summary-item">
                    <h3>Workflow Container</h3>
                    <p><small>${workflow.container}</small></p>
                </div>
                <% } %>
                <div class="summary-item">
                    <h3>Nextflow Version</h3>
                    <p>version ${workflow.nextflow.version}, build ${workflow.nextflow.build}</p>
                </div>
            </div>
        </div>

        <!-- Task Execution Summary -->
        <div class="section">
            <h2>Task Execution Summary</h2>
            
            <div class="summary-grid">
                <div class="summary-item">
                    <h3>Succeeded</h3>
                    <p>${workflow.stats.succeedCount}</p>
                </div>
                <div class="summary-item">
                    <h3>Cached</h3>
                    <p>${workflow.stats.cachedCount}</p>
                </div>
                <div class="summary-item">
                    <h3>Failed</h3>
                    <p>${workflow.stats.effectiveFailedCount}</p>
                </div>
                <div class="summary-item">
                    <h3>Ignored</h3>
                    <p>${workflow.stats.ignoredCount}</p>
                </div>
            </div>
        </div>

        <!-- Sample Selection Section -->
        <div class="section">
            <h2>Select Sample</h2>
            <p>Click on a sample row to view its resource usage and task details.</p>
            <div id="samples-grid"></div>
        </div>
        
        <!-- Resource Usage Charts Section -->
        <div class="section">
            <h2>Resource Usage for <span id="current-sample">[No sample selected]</span></h2>
            <div id="charts-container"></div>
        </div>
        
        <!-- Task Details Section -->
        <div class="section">
            <h2>Task Details</h2>
            <p>Detailed task information filtered by the selected sample.</p>
            <div id="tasks-grid"></div>
        </div>
    </div>
    
    <script>
        // Parse the task data
        const data = ${data};
        
        // Global variables
        let currentSample = null;
        let samplesGrid = null;
        let tasksGrid = null;
        
        // Function to extract unique samples
        function getUniqueSamples(data) {
            const samples = {};
            data.forEach(task => {
                if (task.group_id) {
                    samples[task.group_id] = true;
                }
            });
            return Object.keys(samples).sort();
        }
        
        // Function to count tasks by status for a sample
        function countTasksByStatus(data, sample) {
            const sampleTasks = data.filter(task => task.group_id === sample);
            const counts = { completed: 0, cached: 0, failed: 0, unknown: 0 };
            
            sampleTasks.forEach(task => {
                const status = task.status || 'unknown';
                if (counts.hasOwnProperty(status)) {
                    counts[status]++;
                } else {
                    counts.unknown++;
                }
            });
            
            return counts;
        }
        
        // Initialize GridJS tables
        function initializeTables() {
            const samples = getUniqueSamples(data);
            
            // Samples table with click-to-select
            const samplesData = samples.map(sample => {
                const counts = countTasksByStatus(data, sample);
                return [
                    sample,
                    counts.completed + counts.cached + counts.failed,
                    counts.completed,
                    counts.failed
                ];
            });
            
            samplesGrid = new gridjs.Grid({
                columns: ["Sample ID", "Total Tasks", "Completed", "Failed"],
                data: samplesData,
                search: true,
                sort: true,
                pagination: {
                    enabled: true,
                    limit: 10
                },
                style: {
                    table: {
                        'width': '100%'
                    },
                    th: {
                        'background-color': '#f8f9fa',
                        'font-weight': '600'
                    }
                }
            });
            
            samplesGrid.render(document.getElementById('samples-grid'));
            
            // Add click handler for sample selection
            setTimeout(() => {
                document.querySelectorAll('.gridjs-tr:not(.gridjs-header)').forEach(row => {
                    row.addEventListener('click', function() {
                        const sampleId = this.querySelector('.gridjs-td:nth-child(1)').textContent;
                        selectSample(sampleId);
                    });
                });
            }, 100);
            
            // Initialize tasks table (empty at first)
            updateTasksTable();
        }
        
        // Select sample and update views
        function selectSample(sampleId) {
            currentSample = sampleId;
            document.getElementById('current-sample').textContent = sampleId;
            
            // Highlight selected sample in table
            document.querySelectorAll('.gridjs-tr:not(.gridjs-header)').forEach(row => {
                const rowSample = row.querySelector('.gridjs-td:nth-child(1)')?.textContent;
                if (rowSample === sampleId) {
                    row.style.backgroundColor = '#d4edda';
                } else {
                    row.style.backgroundColor = '';
                }
            });
            
            // Update charts and tasks table
            createCharts(sampleId);
            updateTasksTable(sampleId);
        }
        
        // Update tasks table with sample filter
        function updateTasksTable(sampleFilter = null) {
            let filteredData = data;
            if (sampleFilter) {
                filteredData = data.filter(task => task.group_id === sampleFilter);
            }
            
            const gridData = filteredData.map(task => [
                task.name,
                task.status,
                task.cpu || 'N/A',
                task.memory || 'N/A',
                task.duration || 'N/A',
                task.disk || 'N/A',
                task.group_id || 'N/A'
            ]);
            
            if (tasksGrid) {
                tasksGrid.updateConfig({
                    data: gridData
                }).forceRender();
            } else {
                tasksGrid = new gridjs.Grid({
                    columns: [
                        "Task Name", "Status", "CPU", "Memory (MB)",
                        "Duration (ms)", "Disk (MB)", "Sample"
                    ],
                    data: gridData,
                    search: true,
                    sort: true,
                    pagination: {
                        enabled: true,
                        limit: 20
                    },
                    style: {
                        table: {
                            'width': '100%'
                        },
                        th: {
                            'background-color': '#f8f9fa',
                            'font-weight': '600'
                        }
                    }
                });
                
                tasksGrid.render(document.getElementById('tasks-grid'));
            }
        }
        
        // Create resource usage charts for selected sample
        function createCharts(sample) {
            const chartsContainer = document.getElementById('charts-container');
            chartsContainer.innerHTML = '';
            
            const sampleTasks = data.filter(task => task.group_id === sample);
            
            if (sampleTasks.length === 0) {
                chartsContainer.innerHTML = '<p>No task data available for this sample.</p>';
                return;
            }
            
            // Create CPU chart
            const cpuData = [{
                x: sampleTasks.map(task => task.name),
                y: sampleTasks.map(task => task.cpu || 0),
                type: 'bar',
                marker: {color: '#28a745'}
            }];
            
            Plotly.newPlot(chartsContainer, cpuData, {
                title: 'CPU Usage',
                xaxis: {title: 'Task'},
                yaxis: {title: 'CPU Usage'},
                margin: {t: 40, b: 80}
            });
            
            // Create Memory chart
            const memoryData = [{
                x: sampleTasks.map(task => task.name),
                y: sampleTasks.map(task => task.memory || 0),
                type: 'bar',
                marker: {color: '#007bff'}
            }];
            
            Plotly.newPlot(chartsContainer, memoryData, {
                title: 'Memory Usage',
                xaxis: {title: 'Task'},
                yaxis: {title: 'Memory (MB)'},
                margin: {t: 40, b: 80}
            });
            
            // Create Duration chart
            const durationData = [{
                x: sampleTasks.map(task => task.name),
                y: sampleTasks.map(task => task.duration || 0),
                type: 'bar',
                marker: {color: '#ffc107'}
            }];
            
            Plotly.newPlot(chartsContainer, durationData, {
                title: 'Task Duration',
                xaxis: {title: 'Task'},
                yaxis: {title: 'Duration (ms)'},
                margin: {t: 40, b: 80}
            });
            
            // Create Disk chart
            const diskData = [{
                x: sampleTasks.map(task => task.name),
                y: sampleTasks.map(task => task.disk || 0),
                type: 'bar',
                marker: {color: '#17a2b8'}
            }];
            
            Plotly.newPlot(chartsContainer, diskData, {
                title: 'Disk Usage',
                xaxis: {title: 'Task'},
                yaxis: {title: 'Disk (MB)'},
                margin: {t: 40, b: 80}
            });
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeTables();
        });
    </script>
</body>
</html>