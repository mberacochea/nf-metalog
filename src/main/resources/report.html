<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>[${workflow.runName}] nf-metalog report</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <style>
        /* Light gray background for the entire report */
        body {
            background-color: #f8f9fa;
        }
        
        /* White background for main content area */
        main.container {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            padding: 2rem;
        }
        
        /* Card styling adjustments for light background */
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 0.5rem;
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
        }
        
        /* Minimal custom CSS for nf-metalog specific elements */
        .nf-command {
            font-family: monospace;
            font-size: 0.85em;
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 0.25rem;
            overflow-x: auto;
            max-height: 200px;
        }
        
        /* Chart container styling */
        .chart-container {
            margin: 1rem 0;
            min-height: 400px;
            width: 100%;
        }
        
        /* Status badge styling - adjusted for better visibility on white */
        .status-completed { background-color: #d1e7dd; color: #0f5132; }
        .status-failed { background-color: #f8d7da; color: #842029; }
        .status-running { background-color: #fff3cd; color: #664d03; }
        .status-cached { background-color: #cff4fc; color: #055160; }
        
        /* Adjust header styling for better contrast */
        header.bg-light {
            background-color: white !important;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        /* Clickable table rows - cursor and hover effects */
        .gridjs-tr:not(.gridjs-header):hover {
            cursor: pointer;
            background-color: #f8f9fa !important;
        }
        
        .gridjs-tr.selected-row {
            background-color: #d1e7dd !important;
        }
    </style>
</head>
<body>
    <!-- Bootstrap Header -->
    <header class="bg-light border-bottom mb-4">
        <div class="container py-4">
            <h1 class="display-5 mb-2">Nextflow Workflow Report</h1>
            <p class="lead text-muted">[${workflow.runName}]</p>
        </div>
    </header>
    
    <!-- Main Content Container -->
    <main class="container mb-5" id="main-content">
        
        <!-- Workflow Overview Section -->
        <section class="mb-5">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">Workflow Overview</h2>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                <div class="col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Status</h5>
                            <p class="card-text">
                                <span class="badge bg-${workflow.success ? 'success' : 'danger'}">
                                    ${workflow.success ? 'Completed' : 'Failed'}
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Duration</h5>
                            <p class="card-text">${workflow.duration}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Samples Processed</h5>
                            <p class="card-text" id="sample-count">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Total Tasks</h5>
                            <p class="card-text" id="total-tasks">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Workflow Metadata Section -->
        <section class="mb-5">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">Workflow Metadata</h2>
                </div>
                <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <strong>Nextflow Command:</strong>
                                <div class="bg-light p-2 rounded mt-1" style="font-family: monospace; font-size: 0.85em; overflow-x: auto;">
                                    ${workflow.commandLine}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <strong>Launch Directory:</strong>
                                <div class="text-muted">${workflow.launchDir}</div>
                            </div>
                            <div class="col-md-6">
                                <strong>Work Directory:</strong>
                                <div class="text-muted">${workflow.workDir.toUriString()}</div>
                            </div>
                            <div class="col-md-6">
                                <strong>Project Directory:</strong>
                                <div class="text-muted">${workflow.projectDir}</div>
                            </div>
                            <% if (workflow.scriptName) { %>
                            <div class="col-md-6">
                                <strong>Script Name:</strong>
                                <div>${workflow.scriptName}</div>
                            </div>
                            <% } %>
                            <% if (workflow.scriptId) { %>
                            <div class="col-md-6">
                                <strong>Script ID:</strong>
                                <div><code>${workflow.scriptId}</code></div>
                            </div>
                            <% } %>
                            <div class="col-md-6">
                                <strong>Workflow Session:</strong>
                                <div><code>${workflow.sessionId}</code></div>
                            </div>
                            <% if (workflow.repository) { %>
                            <div class="col-md-6">
                                <strong>Workflow Repository:</strong>
                                <div><code>${workflow.repository}</code></div>
                            </div>
                            <% } %>
                            <div class="col-md-6">
                                <strong>Workflow Profile:</strong>
                                <div>${workflow.profile}</div>
                            </div>
                            <% if (workflow.container) { %>
                            <div class="col-md-6">
                                <strong>Workflow Container:</strong>
                                <div class="text-muted">${workflow.container}</div>
                            </div>
                            <% } %>
                            <div class="col-md-6">
                                <strong>Nextflow Version:</strong>
                                <div>version ${workflow.nextflow.version}, build ${workflow.nextflow.build}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Execution Summary Section -->
        <section class="mb-5">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">Execution Summary</h2>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                <div class="col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Succeeded</h5>
                            <p class="card-text">${workflow.stats.succeedCount}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Cached</h5>
                            <p class="card-text">${workflow.stats.cachedCount}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Failed</h5>
                            <p class="card-text">${workflow.stats.effectiveFailedCount}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Ignored</h5>
                            <p class="card-text">${workflow.stats.ignoredCount}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">CPU-Hours</h5>
                            <p class="card-text">${workflow.stats.computeTimeFmt}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Start Time</h5>
                            <p class="card-text">${workflow.start}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Completion Time</h5>
                            <p class="card-text">${workflow.complete}</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sample Tracking Section -->
        <section class="mb-5">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">Sample Tracking</h2>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">Select a sample to view its resource usage and task execution details.</p>
                    <div id="samples-grid"></div>
                </div>
            </div>
        </section>

        <!-- Resource Analysis Section -->
        <section class="mb-5">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">Resource Analysis for <span id="current-sample" class="text-muted">[No sample selected]</span></h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div id="cpu-chart" class="chart-container"></div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div id="memory-chart" class="chart-container"></div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div id="duration-chart" class="chart-container"></div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div id="disk-chart" class="chart-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Task Details Section -->
        <section class="mb-5">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">Task Details</h2>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">Comprehensive task information filtered by the selected sample.</p>
                    <div id="tasks-grid"></div>
                </div>
            </div>
        </section>
    </main>
    
    <script>
        // Parse the task data
        const data = ${data};
        
        // Global variables
        let currentSample = null;
        let samplesGrid = null;
        let tasksGrid = null;
        
        // Function to extract unique samples
        function getUniqueSamples(data) {
            const samples = {};
            data.forEach(task => {
                if (task.group_id) {
                    samples[task.group_id] = true;
                }
            });
            return Object.keys(samples).sort();
        }
        
        // Function to count tasks by status for a sample
        function countTasksByStatus(data, sample) {
            const sampleTasks = data.filter(task => task.group_id === sample);
            const counts = { completed: 0, cached: 0, failed: 0, unknown: 0 };
            
            sampleTasks.forEach(task => {
                const status = task.status || 'unknown';
                if (counts.hasOwnProperty(status)) {
                    counts[status]++;
                } else {
                    counts.unknown++;
                }
            });
            
            return counts;
        }
        
        // Update overview statistics
        function updateOverviewStats() {
            const samples = getUniqueSamples(data);
            const totalTasks = data.length;
            
            document.getElementById('sample-count').textContent = samples.length;
            document.getElementById('total-tasks').textContent = totalTasks;
        }
        
        // Initialize GridJS tables
        function initializeTables() {
            const samples = getUniqueSamples(data);
            
            // Samples table with click-to-select
            const samplesData = samples.map(sample => {
                const counts = countTasksByStatus(data, sample);
                return [
                    sample,
                    counts.completed + counts.cached + counts.failed,
                    counts.completed,
                    counts.failed
                ];
            });
            
            samplesGrid = new gridjs.Grid({
                columns: ["Sample ID", "Total Tasks", "Completed", "Failed"],
                data: samplesData,
                search: true,
                sort: true,
                pagination: {
                    enabled: true,
                    limit: 10
                },
                style: {
                    table: {
                        'width': '100%'
                    },
                    th: {
                        'background-color': '#f8f9fa',
                        'font-weight': '600'
                    }
                }
            });
            
            samplesGrid.render(document.getElementById('samples-grid'));
            
            // Add click handler for sample selection using event delegation
            // This handles pagination by listening to the container instead of individual rows
            const samplesGridContainer = document.getElementById('samples-grid');
            samplesGridContainer.addEventListener('click', function(e) {
                // Check if the clicked element is a table row (not header)
                let targetRow = e.target.closest('.gridjs-tr:not(.gridjs-header)');
                if (targetRow) {
                    const sampleId = targetRow.querySelector('.gridjs-td:nth-child(1)').textContent;
                    
                    // Remove selection from all rows first
                    document.querySelectorAll('.gridjs-tr.selected-row').forEach(row => {
                        row.classList.remove('selected-row');
                    });
                    
                    // Add selection to clicked row immediately
                    targetRow.classList.add('selected-row');
                    
                    // Select the sample (this will handle charts and tasks)
                    selectSample(sampleId);
                }
            });
            
            // Initialize tasks table (empty at first)
            updateTasksTable();
        }
        
        // Reapply selection highlighting after pagination or other DOM changes
        function reapplySelectionHighlight() {
            if (currentSample) {
                // Remove selection from all rows first
                document.querySelectorAll('.gridjs-tr.selected-row').forEach(row => {
                    row.classList.remove('selected-row');
                });
                
                // Find and highlight the selected row if it's visible
                const allRows = document.querySelectorAll('.gridjs-tr:not(.gridjs-header)');
                allRows.forEach(row => {
                    const rowSample = row.querySelector('.gridjs-td:nth-child(1)')?.textContent;
                    if (rowSample === currentSample) {
                        row.classList.add('selected-row');
                    }
                });
            }
        }
        
        // Select sample and update views
        function selectSample(sampleId) {
            currentSample = sampleId;
            document.getElementById('current-sample').textContent = sampleId;
            
            // Update charts and tasks table
            createCharts(sampleId);
            updateTasksTable(sampleId);
            
            // Reapply selection highlighting in case of pagination
            reapplySelectionHighlight();
        }
        
        // Update tasks table with sample filter
        function updateTasksTable(sampleFilter = null) {
            let filteredData = data;
            if (sampleFilter) {
                filteredData = data.filter(task => task.group_id === sampleFilter);
            }
            
            const gridData = filteredData.map(task => [
                task.name,
                task.status,
                task.cpu || 'N/A',
                task.memory || 'N/A',
                task.duration || 'N/A',
                task.disk || 'N/A',
                task.group_id || 'N/A'
            ]);
            
            if (tasksGrid) {
                tasksGrid.updateConfig({
                    data: gridData
                }).forceRender();
            } else {
                tasksGrid = new gridjs.Grid({
                    columns: [
                        "Task Name", "Status", "CPU", "Memory (MB)",
                        "Duration (ms)", "Disk (MB)", "Sample"
                    ],
                    data: gridData,
                    search: true,
                    sort: true,
                    pagination: {
                        enabled: true,
                        limit: 20
                    },
                    style: {
                        table: {
                            'width': '100%'
                        },
                        th: {
                            'background-color': '#f8f9fa',
                            'font-weight': '600'
                        }
                    }
                });
                
                tasksGrid.render(document.getElementById('tasks-grid'));
            }
        }
        
        // Create resource usage charts for selected sample
        function createCharts(sample) {
            const sampleTasks = data.filter(task => task.group_id === sample);
            
            if (sampleTasks.length === 0) {
                document.getElementById('cpu-chart').innerHTML = '<p class="text-muted">No task data available for this sample.</p>';
                document.getElementById('memory-chart').innerHTML = '';
                document.getElementById('duration-chart').innerHTML = '';
                document.getElementById('disk-chart').innerHTML = '';
                return;
            }
            
            // Helper function to filter out zero/empty values and create chart data
            function createChartData(tasks, valueKey, title, yAxisTitle, color) {
                const nonZeroTasks = tasks.filter(task => task[valueKey] && task[valueKey] > 0);
                
                if (nonZeroTasks.length === 0) {
                    return { hasData: false };
                }
                
                return {
                    hasData: true,
                    data: [{
                        x: nonZeroTasks.map(task => task.name),
                        y: nonZeroTasks.map(task => task[valueKey] || 0),
                        type: 'bar',
                        marker: {color: color}
                    }],
                    layout: {
                        title: title,
                        xaxis: {title: 'Task'},
                        yaxis: {title: yAxisTitle},
                        margin: {t: 40, b: 80}
                    }
                };
            }
            
            // Create CPU chart
            const cpuChart = createChartData(sampleTasks, 'cpu', 'CPU Usage', 'CPU Usage', '#198754');
            if (cpuChart.hasData) {
                Plotly.newPlot('cpu-chart', cpuChart.data, cpuChart.layout);
            } else {
                document.getElementById('cpu-chart').innerHTML = '<p class="text-muted">No CPU data available</p>';
            }
            
            // Create Memory chart
            const memoryChart = createChartData(sampleTasks, 'memory', 'Memory Usage', 'Memory (MB)', '#0d6efd');
            if (memoryChart.hasData) {
                Plotly.newPlot('memory-chart', memoryChart.data, memoryChart.layout);
            } else {
                document.getElementById('memory-chart').innerHTML = '<p class="text-muted">No memory data available</p>';
            }
            
            // Create Duration chart
            const durationChart = createChartData(sampleTasks, 'duration', 'Task Duration', 'Duration (ms)', '#ffc107');
            if (durationChart.hasData) {
                Plotly.newPlot('duration-chart', durationChart.data, durationChart.layout);
            } else {
                document.getElementById('duration-chart').innerHTML = '<p class="text-muted">No duration data available</p>';
            }
            
            // Create Disk chart
            const diskChart = createChartData(sampleTasks, 'disk', 'Disk Usage', 'Disk (MB)', '#0dcaf0');
            if (diskChart.hasData) {
                Plotly.newPlot('disk-chart', diskChart.data, diskChart.layout);
            } else {
                document.getElementById('disk-chart').innerHTML = '<p class="text-muted">No disk data available</p>';
            }
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeTables();
            updateOverviewStats();
            
            // Set up mutation observer to handle pagination changes
            const samplesGridContainer = document.getElementById('samples-grid');
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length > 0) {
                        // DOM has changed (likely due to pagination)
                        reapplySelectionHighlight();
                    }
                });
            });
            
            // Start observing the grid container for changes
            observer.observe(samplesGridContainer, {
                childList: true,
                subtree: true
            });
        });
    </script>
</body>
</html>
